@* Components/Shared/ThemeSelector.razor *@
@using TargetBrowse.Services
@using TargetBrowse.Services.Interfaces
@inject IThemeService ThemeService
@inject IJSRuntime JS
@implements IDisposable

<div class="dropdown-submenu">
    <h6 class="dropdown-header">
        <i class="@GetCurrentThemeIcon() me-2"></i>
        Theme
    </h6>

    @foreach (var theme in _themes)
    {
        @* Use a button with both a Blazor handler (interactive pages) and an inline JS onclick
           (SSR pages like Account/Manage where Blazor events don't wire up).
           tbSetTheme() is a global helper defined in theme.js, always loaded. *@
        <button class="dropdown-item d-flex align-items-center @(theme.Value == _currentTheme ? "active" : "")"
                type="button"
                onclick="tbSetTheme('@theme.Value')">
            <i class="@theme.Icon me-2"></i>
            @theme.Name
            @if (theme.Value == _currentTheme)
            {
                <i class="bi bi-check ms-auto"></i>
            }
        </button>
    }
</div>

@code {
    private string _currentTheme = "auto";
    private DotNetObjectReference<ThemeSelector>? _selfRef;

    private readonly List<ThemeOption> _themes = new()
    {
        new("Auto", "auto", "bi-circle-half"),
        new("Light", "light", "bi-sun-fill"),
        new("Dark", "dark", "bi-moon-fill")
    };

    protected override async Task OnInitializedAsync()
    {
        // Get initial theme (uses cached value during pre-rendering)
        _currentTheme = await ThemeService.GetThemeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Read actual theme from localStorage now that JS is available
            var actualTheme = await ThemeService.GetThemeAsync();
            if (actualTheme != _currentTheme)
            {
                _currentTheme = actualTheme;
                StateHasChanged();
            }

            // Register a JS listener for the themeChanged event dispatched by tbSetTheme,
            // so the checkmark stays in sync when the button's inline onclick fires
            _selfRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("tbRegisterThemeListener", _selfRef);
        }
    }

    // Called from JS when the themeChanged event fires
    [JSInvokable]
    public void OnThemeChangedFromJs(string newTheme)
    {
        _currentTheme = newTheme;
        InvokeAsync(StateHasChanged);
    }

    private string GetCurrentThemeIcon()
    {
        var theme = _themes.FirstOrDefault(t => t.Value == _currentTheme);
        return theme?.Icon ?? "bi-circle-half";
    }

    public void Dispose()
    {
        _selfRef?.Dispose();
    }

    private record ThemeOption(string Name, string Value, string Icon);
}

@* CSS for dropdown submenu styling *@
<style>
    .dropdown-submenu .dropdown-header {
        font-size: 0.875rem;
        color: var(--bs-secondary);
        padding: 0.25rem 1rem;
        margin-bottom: 0.25rem;
        border-bottom: 1px solid var(--bs-border-color);
    }

    .dropdown-submenu .dropdown-item {
        padding: 0.5rem 1.5rem;
        font-size: 0.875rem;
        transition: all 0.15s ease-in-out;
    }

        .dropdown-submenu .dropdown-item:hover {
            background-color: var(--bs-secondary-bg);
            transform: translateX(2px);
        }

        .dropdown-submenu .dropdown-item.active {
            background-color: var(--bs-primary-bg-subtle);
            color: var(--bs-primary-text-emphasis);
            font-weight: 500;
        }

        .dropdown-submenu .dropdown-item i:last-child {
            font-size: 0.75rem;
            opacity: 0.7;
        }
</style>