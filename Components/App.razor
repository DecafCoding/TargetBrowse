<!DOCTYPE html>
<html lang="en" @ServerThemeAttributes>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="@Assets["app.css"]" />
    <link rel="stylesheet" href="@Assets["ChannelVideos.css"]" />
    <!-- Shared Video Card Styles -->
    <link rel="stylesheet" href="@Assets["css/components/video-card.css"]" />
    <link rel="stylesheet" href="@Assets["TargetBrowse.styles.css"]" />
    <ImportMap />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet @rendermode="PageRenderMode" />
    <script>
        // Apply saved theme immediately to prevent FOUC
        (function() {
            try {
                const savedTheme = localStorage.getItem('targetbrowse-theme') || 'auto';
                const htmlElement = document.documentElement;

                if (savedTheme === 'auto') {
                    htmlElement.removeAttribute('data-bs-theme');
                    htmlElement.classList.add('theme-auto');
                } else {
                    htmlElement.setAttribute('data-bs-theme', savedTheme);
                    htmlElement.classList.add(`theme-${savedTheme}`);
                }
            } catch (e) {
                // Ignore errors in case localStorage is not available
            }
        })();

        // Global theme setter called by ThemeSelector buttons via inline onclick.
        // Plain script (not a module) so it works on SSR pages where Blazor
        // interactivity is unavailable (e.g. Account/Manage).
        window.tbSetTheme = function(theme) {
            try {
                var THEME_KEY = 'targetbrowse-theme';
                var h = document.documentElement;
                localStorage.setItem(THEME_KEY, theme);
                document.cookie = THEME_KEY + '=' + theme + ';path=/;max-age=31536000;SameSite=Lax';
                if (theme === 'auto') {
                    h.removeAttribute('data-bs-theme');
                    h.classList.add('theme-auto');
                    h.classList.remove('theme-light', 'theme-dark');
                } else {
                    h.setAttribute('data-bs-theme', theme);
                    h.classList.remove('theme-auto');
                    h.classList.add('theme-' + theme);
                    h.classList.remove('theme-' + (theme === 'light' ? 'dark' : 'light'));
                }
                window.dispatchEvent(new CustomEvent('themeChanged', { detail: theme }));
            } catch (e) {}
        };

        // Called by ThemeSelector.OnAfterRenderAsync on interactive pages to keep
        // the Blazor checkmark in sync when tbSetTheme fires the themeChanged event.
        window.tbRegisterThemeListener = function(dotNetRef) {
            window.addEventListener('themeChanged', function(e) {
                dotNetRef.invokeMethodAsync('OnThemeChangedFromJs', e.detail);
            });
        };

        // Re-apply theme after Blazor enhanced navigation completes.
        // Enhanced nav patches the DOM without re-executing inline scripts,
        // and may strip data-bs-theme from <html> during the diff.
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Blazor !== 'undefined') {
                Blazor.addEventListener('enhancedload', function() {
                    var theme = localStorage.getItem('targetbrowse-theme') || 'auto';
                    var h = document.documentElement;
                    if (theme === 'auto') {
                        h.removeAttribute('data-bs-theme');
                        h.classList.add('theme-auto');
                        h.classList.remove('theme-light', 'theme-dark');
                    } else {
                        h.setAttribute('data-bs-theme', theme);
                        h.classList.remove('theme-auto');
                        h.classList.add('theme-' + theme);
                        h.classList.remove('theme-' + (theme === 'light' ? 'dark' : 'light'));
                    }
                });
            }
        });
    </script>
</head>

<body>
    <Routes @rendermode="PageRenderMode" />
    <script src="_framework/blazor.web.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <!-- Shared Video Card JavaScript -->
    <script src="@Assets["js/components/video-card.js"]"></script>
    <!-- Theme management script -->
    <script src="@Assets["theme.js"]"></script>
    <!-- Thumbnail error handling -->
    <script src="@Assets["thumbnails.js"]"></script>
</body>

</html>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private IComponentRenderMode? PageRenderMode =>
        HttpContext.AcceptsInteractiveRouting() ? InteractiveServer : null;

    // Read theme from cookie so the server renders data-bs-theme on <html> directly.
    // This avoids the issue where Blazor enhanced navigation patches the DOM without
    // re-executing inline <script> tags, which would otherwise lose the theme.
    private string? ServerTheme =>
        HttpContext.Request.Cookies.TryGetValue("targetbrowse-theme", out var theme)
            ? theme : null;

    private MarkupString ServerThemeAttributes
    {
        get
        {
            var theme = ServerTheme;
            // Only allow known values to prevent injection via tampered cookie
            return theme switch
            {
                "light" => new MarkupString("data-bs-theme=\"light\" class=\"theme-light\""),
                "dark" => new MarkupString("data-bs-theme=\"dark\" class=\"theme-dark\""),
                _ => new MarkupString("class=\"theme-auto\"")
            };
        }
    }
}