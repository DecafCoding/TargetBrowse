@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using TargetBrowse.Features.Channels.Models
@using TargetBrowse.Features.Channels.Services
@using TargetBrowse.Features.Channels.Components

@attribute [Authorize]

@rendermode InteractiveServer

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            Channels
        </h5>
    </div>
    <div class="card-body">
        @if (IsLoading)
        {
            <!-- Loading State -->
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading tracked channels...</span>
                </div>
                <p class="text-muted mt-2 mb-0">Loading your tracked channels...</p>
            </div>
        }
        else if (!TrackedChannels.Any())
        {
            <!-- Empty State -->
            <div class="text-center py-4">
                <i class="bi bi-youtube text-muted" style="font-size: 3rem;"></i>
                <h6 class="mt-3 text-muted">No channels tracked yet</h6>
                <p class="text-muted small mb-0">
                    Search for YouTube channels above to start tracking your favorites and get personalized content suggestions.
                </p>
            </div>
        }
        else
        {
            <!-- Channel Cards Grid - UPDATED SECTION -->
            <div class="row g-3">
                @foreach (var channel in TrackedChannels)
                {
                    <div class="col-lg-3 col-md-4 col-sm-2">
                        <ChannelCard Channel="@channel"
                                     OnChannelDeleted="@HandleChannelDeleted"
                                     OnChannelRatingRequested="@HandleChannelRatingRequested" />
                    </div>
                }
            </div>
        }

        @if (TrackedChannels.Any())
        {
            <!-- Channel Limit Information -->
            <div class="mt-3 pt-3 border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        @TrackedChannels.Count of 50 channels tracked
                    </small>
                    @if (TrackedChannels.Count >= 45)
                    {
                        <small class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Approaching limit
                        </small>
                    }
                </div>

                <!-- Progress Bar -->
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar @GetProgressBarClass()"
                         role="progressbar"
                         style="width: @(TrackedChannels.Count * 2)%"
                         aria-valuenow="@TrackedChannels.Count"
                         aria-valuemin="0"
                         aria-valuemax="50">
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Channel Rating Modal -->
<ChannelRatingModal @ref="RatingModal"
                    OnRatingCreated="HandleRatingCreated"
                    OnRatingUpdated="HandleRatingUpdated"
                    OnRatingDeleted="HandleRatingDeleted" />