@using TargetBrowse.Features.Suggestions.Models
@using TargetBrowse.Features.Suggestions.Components
@using System.Net

<div class="card video-card suggestion-card h-100 @GetCardCssClass()">
    <!-- Selection Checkbox (Batch Mode) -->
    @if (AllowSelection)
    {
        <div class="selection-checkbox">
            <input type="checkbox"
                   class="form-check-input"
                   @onchange="ToggleSelection"
                   checked="@IsSelected"
                   id="suggestion-@Suggestion.Id" />
            <label class="form-check-label visually-hidden" for="suggestion-@Suggestion.Id">
                Select suggestion
            </label>
        </div>
    }

    <!-- Video Thumbnail Container -->
    <div class="position-relative video-thumbnail-container">
        <img src="@GetThumbnailUrl()"
             class="card-img-top video-thumbnail"
             alt="@((MarkupString)WebUtility.HtmlDecode(Suggestion.Video.Title))"
             loading="lazy"
             onerror="window.VideoCardHelpers.handleThumbnailError(this, '@Suggestion.Video.YouTubeVideoId')" />

        <!-- Duration Badge -->
        @if (Suggestion.Video.Duration > 0)
        {
            <span class="badge bg-dark position-absolute duration-badge">
                @Suggestion.Video.FormattedDuration
            </span>
        }

        <!-- Score Badge (if available) -->
        @if (Suggestion.Score.HasValue)
        {
            <span class="badge bg-secondary position-absolute score-badge" title="Suggestion Score: @Suggestion.FormattedScore">
                @Suggestion.FormattedScore
            </span>
        }

        <!-- Expiry Warning -->
        @if (Suggestion.IsNearExpiry)
        {
            <span class="badge bg-warning text-dark position-absolute expiry-badge" title="Expires in @Suggestion.DaysUntilExpiry days">
                <i class="bi bi-clock"></i>
                @Suggestion.DaysUntilExpiry d
            </span>
        }
    </div>

    <!-- Video Details -->
    <div class="card-body d-flex flex-column p-3">
        <!-- Video Title -->
        <h6 class="card-title video-title mb-2">
            <a href="@GetYouTubeUrl(Suggestion.Video)"
               target="_blank"
               class="text-decoration-none title-link"
               title="@((MarkupString)WebUtility.HtmlDecode(Suggestion.Video.Title))">
                @((MarkupString)WebUtility.HtmlDecode(Suggestion.Video.Title))
                @if (Suggestion.Video.Title.Length < 50)
                {
                    <i class="bi bi-box-arrow-up-right ms-1 small"></i>
                }
            </a>
        </h6>

        <!-- Channel Info -->
        <div class="video-channel mb-2">
            <small class="text-muted d-flex justify-content-between">
                <a href="@GetChannelUrl(Suggestion.Video)"
                   target="_blank"
                   class="text-muted text-decoration-none channel-link">
                    <i class="bi bi-person-circle me-1"></i>
                    @Suggestion.Video.ChannelName
                </a>
                @if (!string.IsNullOrEmpty(Suggestion.Video.FormattedViewCount))
                {
                    <span title="@(Suggestion.Video.ViewCount.ToString("N0")) views">@Suggestion.Video.FormattedViewCount</span>
                }
            </small>
        </div>

        <!-- Video Metadata -->
        <div class="video-metadata mb-2">
            <small class="text-muted d-flex justify-content-between">
                <span title="Published @Suggestion.Video.PublishedAt.ToString("MMM d, yyyy")">@Suggestion.Video.TimeSincePublished</span>
                <span title="Expires in @Suggestion.DaysUntilExpiry days">
                    <i class="bi bi-hourglass-split me-1"></i>
                    @Suggestion.DaysUntilExpiry days left
                </span>
            </small>
        </div>

        <!-- Suggestion Metadata -->
        <div class="suggestion-metadata mb-3">
            <small class="text-muted d-flex justify-content-between">
                <span>
                    <!-- Suggestion Reason -->
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <SuggestionSourceBadge Suggestion="@Suggestion" ShowText="true" Size="small" />
                    </div>
                </span>
            </small>
        </div>

        <!-- Video Description -->
        @if (!string.IsNullOrEmpty(Suggestion.Video.Description) && Suggestion.Video.Description != "No description available")
        {
            <p class="video-description text-muted small mb-3 flex-grow-1">
                @GetTruncatedDescription()
            </p>
        }

        <!-- Action Buttons -->
        <div class="mt-auto">
            <SuggestionActions Mode="ActionMode.Individual"
                               Suggestion="@Suggestion"
                               OnSuggestionApproved="@OnSuggestionApproved"
                               OnSuggestionDenied="@OnSuggestionDenied" />
        </div>
    </div>
</div>