@using System.Net
@using System.Text.RegularExpressions

<div class="project-videos-list">
    @if (Videos == null || !Videos.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No videos in this project yet.
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
            @foreach (var video in Videos.OrderBy(v => GetVideoOrder(v)))
            {
                var order = GetVideoOrder(video);

                <div class="col">
                    <div class="card video-card h-100">
                        <!-- Video Thumbnail Container -->
                        <div class="position-relative video-thumbnail-container">
                            @if (!string.IsNullOrEmpty(video.ThumbnailUrl))
                            {
                                <img src="@video.ThumbnailUrl"
                                     class="card-img-top video-thumbnail"
                                     alt="@video.Title thumbnail"
                                     loading="lazy"
                                     onerror="this.src='/images/video-placeholder.jpg'" />
                            }
                            else
                            {
                                <div class="card-img-top video-thumbnail d-flex align-items-center justify-content-center bg-secondary">
                                    <i class="bi bi-camera-video text-white" style="font-size: 3rem;"></i>
                                </div>
                            }

                            <!-- Order Number Badge -->
                            @if (order > 0)
                            {
                                <span class="badge bg-secondary position-absolute status-badge" title="Video order in project">
                                    #@order
                                </span>
                            }

                            <!-- Remove Button -->
                            <button type="button"
                                    class="btn btn-danger btn-sm position-absolute remove-btn"
                                    @onclick="() => HandleRemove(video.Id)"
                                    title="Remove from Project">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>

                        <!-- Video Details -->
                        <div class="card-body d-flex flex-column p-3">
                            <!-- Video Title -->
                            <h6 class="card-title video-title mb-2">
                                <a href="/watch/@video.YouTubeVideoId"
                                   class="text-decoration-none title-link"
                                   title="@video.Title">
                                    @video.Title
                                    @if (video.Title.Length < 50)
                                    {
                                        <i class="bi bi-box-arrow-up-right ms-1 small"></i>
                                    }
                                </a>
                            </h6>

                            <!-- Channel Info -->
                            <div class="video-channel mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-person-circle me-1"></i>
                                    @video.ChannelName
                                </small>
                            </div>

                            <!-- Summary Status -->
                            <div class="mb-2">
                                @if (video.HasSummary)
                                {
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Summary available
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        No summary
                                    </span>
                                }
                            </div>

                            <!-- Summary Preview -->
                            @if (ShowSummaryPreview && video.HasSummary)
                            {
                                <div class="video-description text-muted small mb-3 flex-grow-1">
                                    @video.SummaryPreview
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>


@code {
    [Parameter, EditorRequired]
    public List<ProjectVideoViewModel> Videos { get; set; } = new();

    [Parameter]
    public bool ShowSummaryPreview { get; set; } = false;

    [Parameter]
    public EventCallback<Guid> OnRemove { get; set; }

    [Parameter]
    public Guid ProjectId { get; set; }

    private int GetVideoOrder(ProjectVideoViewModel video)
    {
        // Get order from ProjectVideos navigation property
        //var projectVideo = video.ProjectVideos?.FirstOrDefault(pv => pv.ProjectId == ProjectId);
        //return projectVideo?.Order ?? 0;
        return 0;
    }

    private async Task HandleRemove(Guid videoId)
    {
        await OnRemove.InvokeAsync(videoId);
    }

    // private string GetSummaryPreview(string htmlContent)
    // {
    //     if (string.IsNullOrEmpty(htmlContent))
    //         return string.Empty;

    //     // Extract first paragraph from HTML
    //     var firstParagraph = GetFirstParagraph(htmlContent);

    //     // Truncate to max length
    //     const int maxLength = 200;
    //     if (firstParagraph.Length <= maxLength)
    //         return firstParagraph;

    //     return firstParagraph.Substring(0, maxLength) + "...";
    // }

    // private string GetFirstParagraph(string htmlContent)
    // {
    //     // Try to extract content from first <p> tag
    //     var paragraphMatch = Regex.Match(htmlContent, @"<p[^>]*>(.*?)</p>", RegexOptions.Singleline | RegexOptions.IgnoreCase);

    //     if (paragraphMatch.Success)
    //     {
    //         // Strip HTML tags from the paragraph content
    //         var content = paragraphMatch.Groups[1].Value;
    //         return StripHtmlTags(content);
    //     }

    //     // If no <p> tag found, strip all HTML and take first chunk
    //     var stripped = StripHtmlTags(htmlContent);
    //     var firstSentences = stripped.Split('.').Take(2);
    //     return string.Join(". ", firstSentences).Trim();
    // }

    // private string StripHtmlTags(string html)
    // {
    //     if (string.IsNullOrEmpty(html))
    //         return string.Empty;

    //     // Remove HTML tags
    //     var withoutTags = Regex.Replace(html, @"<[^>]+>", " ");

    //     // Decode HTML entities
    //     var decoded = WebUtility.HtmlDecode(withoutTags);

    //     // Clean up whitespace
    //     var cleaned = Regex.Replace(decoded, @"\s+", " ").Trim();

    //     return cleaned;
    // }
}
