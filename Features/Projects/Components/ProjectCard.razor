@using System.Net

<div class="card video-card h-100">
    <!-- Project Header -->
    <div class="card-body d-flex flex-column p-3">
        <!-- Project Title -->
        <h6 class="card-title mb-2">
            <a href="/projects/@Project.Id"
               class="text-decoration-none title-link"
               title="@Project.Name">
                @Project.Name
            </a>
        </h6>

        <!-- Project Description -->
        @if (!string.IsNullOrEmpty(Project.DescriptionPreview))
        {
            <p class="text-muted small mb-3">
                @GetTruncatedDescription()
            </p>
        }

        <!-- Project Metadata -->
        <div class="project-metadata mb-3">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <!-- Video Count Badge -->
                <span class="badge bg-primary">
                    <i class="bi bi-camera-video me-1"></i>
                    @Project.VideoCount @(Project.VideoCount == 1 ? "video" : "videos")
                </span>

                <!-- Guide Status Indicator -->
                @if (Project.HasGuide)
                {
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>
                        Guide Generated
                    </span>
                }
                else
                {
                    <span class="badge bg-secondary">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        No Guide
                    </span>
                }
            </div>
        </div>

        <!-- Last Modified -->
        <div class="mb-3">
            <small class="text-muted">
                <i class="bi bi-clock-history me-1"></i>
                Modified @GetRelativeTime(Project.LastModifiedAt)
            </small>
        </div>

        <!-- Action Buttons -->
        <div class="mt-auto">
            <div class="d-flex gap-2">
                <a href="/projects/@Project.Id"
                   class="btn btn-primary btn-sm flex-fill"
                   title="View Project">
                    <i class="bi bi-eye me-1"></i>
                    View
                </a>
                <button type="button"
                        class="btn btn-outline-secondary btn-sm flex-fill"
                        @onclick="HandleEdit"
                        title="Edit Project">
                    <i class="bi bi-pencil me-1"></i>
                    Edit
                </button>
                <button type="button"
                        class="btn btn-outline-danger btn-sm"
                        @onclick="HandleDelete"
                        title="Delete Project">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public ProjectListViewModel Project { get; set; } = null!;

    [Parameter]
    public EventCallback<Guid> OnDelete { get; set; }

    [Parameter]
    public EventCallback<Guid> OnEdit { get; set; }

    [Parameter]
    public EventCallback<Guid> OnView { get; set; }

    private string GetTruncatedDescription()
    {
        if (string.IsNullOrEmpty(Project.DescriptionPreview))
            return string.Empty;

        const int maxLength = 150;
        if (Project.DescriptionPreview.Length <= maxLength)
            return Project.DescriptionPreview;

        return Project.DescriptionPreview.Substring(0, maxLength) + "...";
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} {((int)timeSpan.TotalMinutes == 1 ? "minute" : "minutes")} ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} {((int)timeSpan.TotalHours == 1 ? "hour" : "hours")} ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)timeSpan.TotalDays} {((int)timeSpan.TotalDays == 1 ? "day" : "days")} ago";
        if (timeSpan.TotalDays < 365)
            return $"{(int)(timeSpan.TotalDays / 30)} {((int)(timeSpan.TotalDays / 30) == 1 ? "month" : "months")} ago";

        return $"{(int)(timeSpan.TotalDays / 365)} {((int)(timeSpan.TotalDays / 365) == 1 ? "year" : "years")} ago";
    }

    private async Task HandleEdit()
    {
        await OnEdit.InvokeAsync(Project.Id);
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync(Project.Id);
    }

    private async Task HandleView()
    {
        await OnView.InvokeAsync(Project.Id);
    }
}
