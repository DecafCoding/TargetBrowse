@page "/video-library"
@using Microsoft.AspNetCore.Authorization
@using TargetBrowse.Features.Videos.Models
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Video Library - YouTube Video Tracker</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-1">My Video Library</h1>
        <p class="text-muted mb-0">
            Manage and organize your saved YouTube videos for focused content consumption. You have @Videos.Count in your library.
            @if (RatedVideosCount > 0)
            {
                <span class="ms-2">
                    <i class="bi bi-star-fill text-warning"></i>
                    @RatedVideosCount rated
                </span>
            }
        </p>
    </div>
    <div>
        <div class="btn-group" role="group">
            <a href="/video-search"
               class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-search me-1"></i>
                Search Videos
            </a>
            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    @onclick="RefreshAsync">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Refresh
            </button>
        </div>
    </div>
</div>

<!-- Debug Information (only visible in development) -->
@if (ShowDebugInfo)
{
    <div class="alert alert-info mb-4">
        <strong>Debug Info:</strong>
        <br />User ID: @CurrentUserId
        <br />Is Loading: @IsLoading
        <br />Videos Count: @Videos.Count
        <br />Filtered Count: @FilteredVideos.Count
        <br />Rated Videos: @RatedVideosCount
        <br />Last Error: @LastError
    </div>
}

<div class="row">
    <div class="col-lg-12">
        <!-- My Video Library Section -->
        <div class="card">
            <div class="card-body">
                @if (IsLoading)
                {
                    <!-- Loading State -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-3 text-muted">Loading your video library...</div>
                    </div>
                }
                else if (!string.IsNullOrEmpty(LastError))
                {
                    <!-- Error State -->
                    <div class="alert alert-danger">
                        <h5 class="alert-heading">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Unable to Load Library
                        </h5>
                        <p class="mb-2">@LastError</p>
                        <hr>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-danger btn-sm" @onclick="RefreshAsync">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Try Again
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleDebugInfo">
                                <i class="bi bi-bug me-1"></i>
                                @(ShowDebugInfo ? "Hide" : "Show") Debug Info
                            </button>
                        </div>
                    </div>
                }
                else if (!Videos.Any())
                {
                    <!-- Empty State -->
                    <div class="text-center py-5">
                        <i class="bi bi-collection-play text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">Your video library is empty</h5>
                        <p class="text-muted mb-4">
                            Start building your collection by searching for videos and adding them to your library.
                        </p>
                        <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center">
                            <a href="/video-search" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>
                                Search for Videos
                            </a>
                            <a href="/suggestions" class="btn btn-outline-secondary">
                                <i class="bi bi-magic me-2"></i>
                                Get Suggestions
                            </a>
                        </div>
                        <small class="text-muted mt-3 d-block">
                            <i class="bi bi-info-circle me-1"></i>
                            Need ideas? Check out suggestions based on your topics and channels
                        </small>
                    </div>
                }
                else
                {
                    <!-- Library Controls - Search, Sort, Filter, and Count on same line -->
                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3 mb-4">
                        <!-- Search Input (takes up remaining space) -->
                        <div class="flex-grow-1" style="min-width: 200px;">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text"
                                       class="form-control"
                                       placeholder="Search your library..."
                                       @bind="LibrarySearchQuery"
                                       @oninput="OnLibrarySearchInput" />
                                @if (!string.IsNullOrWhiteSpace(LibrarySearchQuery))
                                {
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            @onclick="ClearLibrarySearch">
                                        <i class="bi bi-x"></i>
                                    </button>
                                }
                            </div>
                        </div>

                        <!-- Rating Filter Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown">
                                <i class="bi bi-star me-1"></i>
                                Filter: @CurrentRatingFilter
                            </button>
                            <ul class="dropdown-menu">
                                <li><button class="dropdown-item" @onclick='() => SetRatingFilter("All Videos")'>All Videos</button></li>
                                <li><button class="dropdown-item" @onclick='() => SetRatingFilter("Rated")'>Rated Videos</button></li>
                                <li><button class="dropdown-item" @onclick='() => SetRatingFilter("Not Rated")'>Not Rated</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" @onclick='() => SetRatingFilter("5 Stars")'>5 Stars</button></li>
                                <li><button class="dropdown-item" @onclick='() => SetRatingFilter("4+ Stars")'>4+ Stars</button></li>
                                <li><button class="dropdown-item" @onclick='() => SetRatingFilter("3+ Stars")'>3+ Stars</button></li>
                                <li><button class="dropdown-item" @onclick='() => SetRatingFilter("1-2 Stars")'>1-2 Stars</button></li>
                            </ul>
                        </div>

                        <!-- Sort Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown">
                                <i class="bi bi-funnel me-1"></i>
                                Sort: @CurrentSortOption
                            </button>
                            <ul class="dropdown-menu">
                                <li><button class="dropdown-item" @onclick="SortByDateAdded">Date Added</button></li>
                                <li><button class="dropdown-item" @onclick="SortByTitle">Title</button></li>
                                <li><button class="dropdown-item" @onclick="SortByDuration">Duration</button></li>
                                <li><button class="dropdown-item" @onclick="SortByViews">Views</button></li>
                                <li><button class="dropdown-item" @onclick="SortByPublished">Published Date</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" @onclick="SortByRating">Rating (High to Low)</button></li>
                                <li><button class="dropdown-item" @onclick="SortByRatingLowToHigh">Rating (Low to High)</button></li>
                            </ul>
                        </div>

                        <!-- Video Count -->
                        <div class="text-muted small text-nowrap">
                            @if (FilteredVideos.Count != Videos.Count)
                            {
                                <span>Showing @FilteredVideos.Count of @Videos.Count videos</span>
                            }
                            else
                            {
                                <span>@Videos.Count videos in your library</span>
                            }
                        </div>
                    </div>

                    <!-- Video Grid using VideoCard Component -->
                    <div class="row">
                        @foreach (var video in FilteredVideos)
                        {
                            <div class="col-md-6 col-lg-4 mb-4">
                                <VideoCard Video="@video"
                                           DisplayMode="VideoDisplayMode.Library"
                                           OnVideoRemoved="@HandleVideoRemoved"
                                           OnWatchStatusChanged="@HandleWatchStatusChanged"
                                           OnVideoRated="@HandleVideoRated" />
                            </div>
                        }
                    </div>

                    <!-- Load More (if needed for large libraries) -->
                    @if (FilteredVideos.Count >= 20)
                    {
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-outline-primary" disabled>
                                <i class="bi bi-arrow-down-circle me-2"></i>
                                Load More Videos
                            </button>
                            <div class="small text-muted mt-2">
                                Pagination will be implemented for large libraries
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>