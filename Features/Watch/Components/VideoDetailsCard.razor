@using TargetBrowse.Features.Watch.Models
@using TargetBrowse.Data.Entities

<div class="card shadow-sm mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            Video Details
        </h5>
    </div>
    <div class="card-body">
        <!-- Video Title -->
        <h6 class="fw-semibold lh-sm mb-2">
            @Model.Title
        </h6>

        <!-- Channel Name -->
        <div class="mb-2">
            <span class="fw-semibold">@Model.ChannelName</span>
        </div>

        <!-- Stats Row -->
        <div class="d-flex justify-content-between text-muted mb-2" style="font-size: 0.9rem;">
            @if (!string.IsNullOrEmpty(Model.ViewCountDisplay))
            {
                <span><i class="bi bi-eye me-1"></i>@Model.ViewCountDisplay</span>
            }
            @if (!string.IsNullOrEmpty(Model.LikeCountDisplay))
            {
                <span><i class="bi bi-hand-thumbs-up me-1"></i>@Model.LikeCountDisplay</span>
            }
            @if (!string.IsNullOrEmpty(Model.CommentCountDisplay))
            {
                <span><i class="bi bi-chat me-1"></i>@Model.CommentCountDisplay</span>
            }
            <span><i class="bi bi-calendar me-1"></i>@Model.PublishedDisplay</span>
        </div>

        <!-- Video Type Dropdown -->
        <div class="d-flex align-items-center gap-2 mb-3">
            <label for="videoTypeSelect" class="form-label fw-semibold mb-0 text-nowrap">Video Type</label>
            <select id="videoTypeSelect"
                    class="form-select form-select-sm"
                    value="@Model.VideoTypeId"
                    @onchange="HandleVideoTypeChange">
                <option value="">-- Select Type --</option>
                @foreach (var videoType in Model.AvailableVideoTypes)
                {
                    <option value="@videoType.Id">@videoType.Name</option>
                }
            </select>
        </div>

        <!-- Status Badges -->
        <div class="d-flex flex-wrap gap-2">
            <!-- Watch Status Badge -->
            <span class="badge @GetWatchStatusBadgeClass()">
                <i class="bi @GetWatchStatusIcon() me-1"></i>
                @GetWatchStatusDisplay()
            </span>

            @if (Model.IsInLibrary)
            {
                <span class="badge bg-success">
                    <i class="bi bi-bookmark-check me-1"></i>
                    In Library
                </span>
            }

            @if (Model.UserRating.HasValue)
            {
                <span class="badge bg-warning">
                    <i class="bi bi-star-fill me-1"></i>
                    @Model.UserRating.Value @(Model.UserRating.Value == 1 ? "Star" : "Stars")
                </span>
            }

            @if (!string.IsNullOrEmpty(Model.DurationDisplay))
            {
                <span class="badge bg-secondary ms-auto">
                    <i class="bi bi-clock me-1"></i>
                    @Model.DurationDisplay
                </span>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public WatchViewModel Model { get; set; } = new();

    [Parameter]
    public EventCallback<Guid?> OnVideoTypeChanged { get; set; }

    private async Task HandleVideoTypeChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        Guid? newVideoTypeId = null;

        if (!string.IsNullOrEmpty(value) && Guid.TryParse(value, out var parsedGuid))
        {
            newVideoTypeId = parsedGuid;
        }

        await OnVideoTypeChanged.InvokeAsync(newVideoTypeId);
    }

    private string GetWatchStatusBadgeClass()
    {
        return Model.WatchStatus switch
        {
            WatchStatus.Watched => "bg-success",
            WatchStatus.Skipped => "bg-secondary",
            _ => "bg-info"
        };
    }

    private string GetWatchStatusIcon()
    {
        return Model.WatchStatus switch
        {
            WatchStatus.Watched => "bi-check-circle-fill",
            WatchStatus.Skipped => "bi-skip-forward-circle-fill",
            _ => "bi-circle"
        };
    }

    private string GetWatchStatusDisplay()
    {
        return Model.WatchStatus switch
        {
            WatchStatus.Watched => "Watched",
            WatchStatus.Skipped => "Skipped",
            _ => "Not Watched"
        };
    }
}
