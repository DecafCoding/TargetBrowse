@using TargetBrowse.Features.Watch.Models
@using TargetBrowse.Data.Entities

<div class="card shadow-sm mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Video Details
        </h5>
    </div>
    <div class="card-body">
        <!-- Video Title -->
        <h6 class="fw-semibold lh-sm mb-3">
            @Model.Title
        </h6>

        <!-- Duration Badge -->
        @if (!string.IsNullOrEmpty(Model.DurationDisplay))
        {
            <div class="mb-3">
                <span class="badge bg-secondary fs-6">
                    <i class="bi bi-clock me-1"></i>
                    @Model.DurationDisplay
                </span>
            </div>
        }

        <!-- Video Type Dropdown -->
        <div class="mb-3">
            <label for="videoTypeSelect" class="form-label fw-semibold">
                <i class="bi bi-tag me-1"></i>
                Video Type
            </label>
            <select id="videoTypeSelect"
                    class="form-select"
                    value="@Model.VideoTypeId"
                    @onchange="HandleVideoTypeChange">
                <option value="">-- Select Type --</option>
                @foreach (var videoType in Model.AvailableVideoTypes)
                {
                    <option value="@videoType.Id">@videoType.Name</option>
                }
            </select>
        </div>

        <!-- Channel Information -->
        <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
                @if (!string.IsNullOrEmpty(Model.ChannelThumbnailUrl))
                {
                    <div class="me-2">
                        <img src="@Model.ChannelThumbnailUrl"
                             class="rounded-circle"
                             alt="@Model.ChannelName"
                             loading="lazy"
                             width="40"
                             height="40"
                             style="object-fit: cover;"
                             onerror="handleChannelThumbnailError(this)" />
                    </div>
                }
                <div>
                    <div class="fw-semibold">@Model.ChannelName</div>
                </div>
            </div>
        </div>

        <!-- Video Statistics -->
        <div class="mb-3">
            @if (!string.IsNullOrEmpty(Model.ViewCountDisplay))
            {
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-eye me-2 text-muted"></i>
                    <span>@Model.ViewCountDisplay</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(Model.LikeCountDisplay))
            {
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-hand-thumbs-up me-2 text-muted"></i>
                    <span>@Model.LikeCountDisplay</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(Model.CommentCountDisplay))
            {
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-chat me-2 text-muted"></i>
                    <span>@Model.CommentCountDisplay</span>
                </div>
            }

            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-calendar me-2 text-muted"></i>
                <span>@Model.PublishedDisplay</span>
            </div>
        </div>

        <!-- Status Badges -->
        <div class="d-flex flex-wrap gap-2">
            <!-- Watch Status Badge -->
            <span class="badge @GetWatchStatusBadgeClass()">
                <i class="bi @GetWatchStatusIcon() me-1"></i>
                @GetWatchStatusDisplay()
            </span>

            @if (Model.IsInLibrary)
            {
                <span class="badge bg-success">
                    <i class="bi bi-bookmark-check me-1"></i>
                    In Library
                </span>
            }

            @if (Model.UserRating.HasValue)
            {
                <span class="badge bg-warning">
                    <i class="bi bi-star-fill me-1"></i>
                    @Model.UserRating.Value @(Model.UserRating.Value == 1 ? "Star" : "Stars")
                </span>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public WatchViewModel Model { get; set; } = new();

    [Parameter]
    public EventCallback<Guid?> OnVideoTypeChanged { get; set; }

    private async Task HandleVideoTypeChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        Guid? newVideoTypeId = null;

        if (!string.IsNullOrEmpty(value) && Guid.TryParse(value, out var parsedGuid))
        {
            newVideoTypeId = parsedGuid;
        }

        await OnVideoTypeChanged.InvokeAsync(newVideoTypeId);
    }

    private string GetWatchStatusBadgeClass()
    {
        return Model.WatchStatus switch
        {
            WatchStatus.Watched => "bg-success",
            WatchStatus.Skipped => "bg-secondary",
            _ => "bg-info"
        };
    }

    private string GetWatchStatusIcon()
    {
        return Model.WatchStatus switch
        {
            WatchStatus.Watched => "bi-check-circle-fill",
            WatchStatus.Skipped => "bi-skip-forward-circle-fill",
            _ => "bi-circle"
        };
    }

    private string GetWatchStatusDisplay()
    {
        return Model.WatchStatus switch
        {
            WatchStatus.Watched => "Watched",
            WatchStatus.Skipped => "Skipped",
            _ => "Not Watched"
        };
    }
}
